// Prisma Schema for Extreme Dept Kidz E-Commerce Platform
// This schema defines the database structure for products, orders, inventory, and more

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CATEGORIES & COLLECTIONS
// ============================================

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  image       String?
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  isActive    Boolean    @default(true)
  metadata    Json? // Additional category metadata
  products    Product[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([slug])
  @@index([parentId])
}

model Collection {
  id          String              @id @default(cuid())
  name        String
  slug        String              @unique
  description String?
  image       String?
  bannerImage String?
  isActive    Boolean             @default(true)
  metadata    Json?
  products    ProductCollection[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([slug])
}

// ============================================
// PRODUCTS
// ============================================

model Product {
  id            String              @id @default(cuid())
  name          String
  slug          String              @unique
  description   String              @db.Text
  price         Int // Price in pesewas (e.g., 12900 = â‚µ129.00)
  originalPrice Int? // Original price for sale items
  sku           String?             @unique
  weight        Float? // Weight in grams
  length        Float? // Length in cm
  width         Float? // Width in cm
  height        Float? // Height in cm
  inStock       Boolean             @default(true) // Computed from variants
  metadata      Json? // Additional product metadata
  categoryId    String
  category      Category            @relation(fields: [categoryId], references: [id])
  images        ProductImage[]
  variants      ProductVariant[]
  tags          ProductTag[]
  collections   ProductCollection[]
  orderItems    OrderItem[]
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([slug])
  @@index([categoryId])
  @@index([inStock])
  @@index([sku])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  alt       String?
  isPrimary Boolean  @default(false)
  order     Int      @default(0) // For ordering images
  createdAt DateTime @default(now())

  @@index([productId])
}

model ProductVariant {
  id                String         @id @default(cuid())
  productId         String
  product           Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  size              String
  color             String? // Optional color variant
  sku               String         @unique
  price             Int? // Override product price if different
  stock             Int            @default(0)
  reserved          Int            @default(0) // Reserved in carts/checkout
  lowStockThreshold Int            @default(10)
  isActive          Boolean        @default(true)
  inventoryLogs     InventoryLog[]
  orderItems        OrderItem[]
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@unique([productId, size, color])
  @@index([productId])
  @@index([sku])
  @@index([stock])
}

model ProductTag {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  name      String // e.g., "new", "sale", "bestseller"
  createdAt DateTime @default(now())

  @@unique([productId, name])
  @@index([productId])
  @@index([name])
}

model ProductCollection {
  id           String     @id @default(cuid())
  productId    String
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  order        Int        @default(0) // For ordering products in collection
  createdAt    DateTime   @default(now())

  @@unique([productId, collectionId])
  @@index([productId])
  @@index([collectionId])
}

// ============================================
// INVENTORY MANAGEMENT
// ============================================

model InventoryLog {
  id        String         @id @default(cuid())
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  change    Int // Positive for additions, negative for deductions
  reason    String // "sale", "restock", "return", "adjustment", "reservation", "release"
  orderId   String? // If related to an order
  notes     String?
  createdAt DateTime       @default(now())

  @@index([variantId])
  @@index([orderId])
  @@index([createdAt])
}

// ============================================
// ORDERS
// ============================================

model Order {
  id              String        @id @default(cuid())
  orderNumber     String        @unique // Human-readable: ORD-2024-001
  userId          String? // Optional: for guest checkout
  user            User?         @relation(fields: [userId], references: [id])
  status          OrderStatus   @default(PENDING)
  subtotal        Int // Subtotal in cents
  shipping        Int // Shipping cost in cents
  tax             Int // Tax in cents
  total           Int // Total in cents
  shippingAddress Json // ShippingAddress type
  billingAddress  Json? // BillingAddress type (if different)
  paymentMethod   String // "card", "paypal", "apple-pay"
  paymentIntentId String? // Stripe payment intent ID
  paymentStatus   PaymentStatus @default(PENDING)
  trackingNumber  String?
  carrier         String? // "usps", "ups", "fedex", "dhl"
  shippedAt       DateTime?
  deliveredAt     DateTime?
  cancelledAt     DateTime?
  cancelledReason String?
  items           OrderItem[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([orderNumber])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

model OrderItem {
  id        String         @id @default(cuid())
  orderId   String
  order     Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product        @relation(fields: [productId], references: [id])
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  quantity  Int
  price     Int // Price at time of purchase (in cents)
  createdAt DateTime       @default(now())

  @@index([orderId])
  @@index([productId])
}

// ============================================
// USERS (for future authentication)
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  passwordHash  String? // For email/password auth
  emailVerified Boolean  @default(false)
  image         String?
  role          UserRole @default(CUSTOMER)
  orders        Order[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([email])
}

enum UserRole {
  CUSTOMER
  ADMIN
}
